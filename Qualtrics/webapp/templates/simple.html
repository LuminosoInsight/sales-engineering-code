{% extends "layout.html" %}
{% block body %}
<script type="text/javascript">


  $(function() {

    var submit_form = function(e) {
      $.getJSON($SCRIPT_ROOT + '/_step1', {
        token: $('input[name=token]').val()
      }, function(data) {
        //$('#result').text(data.result);
        //console.log("server response:" + JSON.stringify(data));
        w = JSON.stringify(data);
        //$('#result').text(w);

        var obj = JSON.parse(w);
        var d = {};
        var selectSurveyCode = 'Select which survey you would like to upload:<br>';
        selectSurveyCode += '<select name="surveys">';
        
        for(var key in obj){
          if (obj.hasOwnProperty(key)){
           var value=obj[key];
           console.log("key:" + key);
           console.log("value:" + value);
           d[key] = value;
           selectSurveyCode += '<option value='+value+'>'+key+'</option>';
          }
        }
        selectSurveyCode += '</select>'
        selectSurveyCode += '<input type="submit" name="submitSurveySelect" value="Select this Survey"/>'

        $('#surveys').html(selectSurveyCode);

        $('input[name=submitSurveySelect]').bind('click', function() {
          console.log("sending over: " + $('select[name=surveys]').val() + " and token: " + $('input[name=token]').val());
         $.getJSON($SCRIPT_ROOT + '/_step2', {
          //sending over the sid of the survey
          sid: $('select[name=surveys]').val(), 
          token: $('input[name=token]').val()
          }, function(data) {

            questions = JSON.stringify(data);
            var apple = JSON.parse(questions);

            for(var key in apple){ //Create selections for Documents
              if (apple.hasOwnProperty(key)){
                 var value=apple[key];

                 if (key == 'text'){
                  var selectTextCode = 'Select which questions to have as documents:<br>';
                  selectTextCode += '<table>';
                  for (var i = 0; i < apple.text.length; i++){
                     selectTextCode += '<tr>';
                     selectTextCode += '<td><input type="radio" name="docSelect" value="'+apple.text[i][0]+'"/></td>';
                     selectTextCode += '<td>' + apple.text[i][0] + '</td><td>' + apple.text[i][1] + '</td></tr>';
                  } 
                  selectTextCode += '</table>';
                  
                 } 

                 if (key == 'subsets'){ //Create selections for Subsets
                  var selectSubsetCode = 'Select which questions to have as subsets:<br>';
                  selectSubsetCode += '<table>';
                  for (var i = 0; i < apple.subsets.length; i++){
                     selectSubsetCode += '<tr>';
                     selectSubsetCode += '<td><input type="checkbox" name="subSelect[]" value="'+apple.subsets[i][0]+'"/></td>';
                     selectSubsetCode += '<td>' + apple.subsets[i][0] + '</td><td>' + apple.subsets[i][1] + '</td></tr>';
                  }
                  selectSubsetCode += '</table>';
                  selectSubsetCode += '<br><input type="submit" name="formSubmit" value="Create Project"/>'
                 }
                 
              }
             }
            $('#text').html(selectTextCode);
            $('#subsets').html(selectSubsetCode);
            //$('#questions').text(questions);


              $('input[name=formSubmit]').bind('click', function() {
                
                var checked = [];   
                $('input[type="checkbox"]:checked').each(function() {
                    checked.push($(this).val());
                  });
                var checkedStr = JSON.stringify(checked);
                console.log("subset: " + checkedStr);
                console.log("docSelect: " + $('input[name=docSelect]:checked').val());
                $.getJSON($SCRIPT_ROOT + '/_step3', {
               //sending over the sid of the survey
                 sid: $('select[name=surveys]').val(), 
                 token: $('input[name=token]').val(),
                 text_q: $('input[name=docSelect]').val(),
                 subset_qs: checkedStr
                }, function(data) {

                });

              });

                 //console.log("data submitted");
           });  //end of step2 function(data)
         });



        }); //end of step1 function(data)
        return false;
    }; //end of variable submit_form

    $('input[name=sub_cred]').bind('click', submit_form);


    
    $('input[type=text]').bind('keydown', function(e) {
      if (e.keyCode == 13) {
        submit_form(e);
      }
    });

    



    
    



  }); //end of main function


</script>





<h1>Qualtrics</h1>
  <p>
  Enter Token: <input type="text" size="50" name="token" value="YGt8lpZHTOfbUip5puXwQVlARk2CfMaGeusxyPHD">
  <br>
  <input type="submit" name="sub_cred" value="Get Surveys"/>
  </p>

  <p>
  
  <span id="surveys"></span>

  </p>

  <p>

  <span id="questions"></span>
</p>

<p>

  <span id="text"></span>
</p>
<p>
  <span id="subsets"></span>

</p>
  


  

{% endblock %}